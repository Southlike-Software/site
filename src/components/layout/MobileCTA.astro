---
const calUrl = import.meta.env.PUBLIC_CAL_URL || "https://cal.com/southlike";
---

<div id="mobile-cta" class="fixed inset-x-0 bottom-0 z-50 hidden sm:hidden" role="region" aria-label="CTA mobile">
  <div class="mx-auto max-w-7xl px-4 pb-[env(safe-area-inset-bottom)]">
    <div class="mb-4 flex items-center gap-3 rounded-xl border border-neutral-800/80 bg-surface-900/90 p-3 pr-12 backdrop-blur">
      <div class="min-w-0 flex-1">
        <p class="text-sm font-medium text-neutral-100">Pronto para escalar com IA?</p>
        <p class="text-xs text-neutral-400">Agende uma consulta gratuita.</p>
      </div>
      <a
        href={calUrl}
        target="_blank"
        rel="noopener"
        class="inline-flex shrink-0 items-center rounded-lg bg-gradient-to-r from-brand-500 to-brand-400 px-4 py-2 text-sm font-medium text-surface-950"
        onclick="posthog?.capture('cta_click', { location: 'mobile_cta', cta: 'agendar' })"
      >Agendar</a>
      <button
        type="button"
        class="absolute right-2 top-2 z-10 inline-flex h-8 w-8 items-center justify-center rounded-full text-neutral-300/90 hover:text-white"
        aria-label="Fechar"
        data-close-mobile-cta
      >
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
  try {
    const root = document.getElementById('mobile-cta');
    if (root && window.innerWidth < 640) {
      const DISMISS_KEY = 'mobile_cta:dismissed_at';
      const DISMISS_TTL_MS = 6 * 60 * 60 * 1000;

      const isDismissed = () => {
        const raw = sessionStorage.getItem(DISMISS_KEY);
        const ts = raw ? parseInt(raw, 10) : NaN;
        return Number.isFinite(ts) && (Date.now() - ts) < DISMISS_TTL_MS;
      };

      const dismiss = () => {
        if (!root.isConnected) return;
        sessionStorage.setItem(DISMISS_KEY, String(Date.now()));
        root.classList.add('hidden');
        posthog?.capture?.('mobile_cta_dismiss');
      };

      if (isDismissed()) {
        root.remove();
      } else {
        // Show after scrolling past hero
        const observer = new IntersectionObserver((entries) => {
          for (const entry of entries) {
            if (!entry.isIntersecting) {
              root.classList.remove('hidden');
              observer.disconnect();
            }
          }
        }, { threshold: 0 });

        const hero = document.querySelector('[data-hero]');
        if (hero) observer.observe(hero);
        else root.classList.remove('hidden');

        const closeBtn = root.querySelector('[data-close-mobile-cta]');
        if (closeBtn) closeBtn.addEventListener('click', dismiss, { once: true });
      }
    }
  } catch {}
</script>
